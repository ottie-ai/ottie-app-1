# Premium Fonts Setup Guide

Quick guide to enable premium fonts for your workspace.

## Prerequisites

- Premium font files uploaded to `/public/fonts/premium/`
- Database migration `add-premium-fonts-feature.sql` applied
- Plan has `feature_premium_fonts = true`

## Step 1: Apply Database Migration

Run the migration to add `feature_premium_fonts` column to plans table:

```bash
psql -h your-db-host -U your-db-user -d your-db-name -f supabase/add-premium-fonts-feature.sql
```

Or via Supabase Dashboard:
1. Go to SQL Editor
2. Copy contents of `supabase/add-premium-fonts-feature.sql`
3. Run the query

## Step 2: Enable Premium Fonts for Plans

Decide which plans should have access to premium fonts:

```sql
-- Enable for Agency and Enterprise plans (recommended)
UPDATE plans 
SET feature_premium_fonts = true 
WHERE name IN ('agency', 'enterprise');

-- Or enable for Growth+ plans
UPDATE plans 
SET feature_premium_fonts = true 
WHERE name IN ('growth', 'agency', 'enterprise');

-- Verify
SELECT name, feature_premium_fonts FROM plans ORDER BY price_cents;
```

## Step 3: Verify Implementation

### Check Font Files

```bash
ls -la public/fonts/premium/
# Should show:
# - Jedira/
# - Pennywise/
# - Poria/
```

### Check Code

1. **Font definitions** in `lib/fonts.ts`:
   ```typescript
   export const premiumFonts: FontOption[] = [...]
   ```

2. **FontSelector** shows premium badge
3. **FontLoader** loads premium fonts via @font-face

### Test in UI

1. **As user WITHOUT premium fonts access:**
   - Open site editor (`/sites/[id]`)
   - Go to Settings tab
   - Click font selector
   - Premium fonts should be **disabled** with "Premium" badge

2. **As user WITH premium fonts access:**
   - Upgrade workspace to agency/enterprise plan (or enable feature manually)
   - Open site editor (`/sites/[id]`)
   - Go to Settings tab
   - Click font selector
   - Premium fonts should be **enabled**
   - Select a premium font (e.g., Jedira)
   - Font should update immediately in preview (direct rendering, no iframe)
   - Save and publish site
   - Visit published site → font should load correctly

## Step 4: Marketing (Optional)

Add premium fonts to pricing page features:

```typescript
// In lib/pricing-data.ts
{
  name: 'Premium text & heading styles',
  // Automatically shown for plans with feature_premium_fonts = true
}
```

## Troubleshooting

### Premium fonts not loading in builder or published site

**Check:**
1. Font files exist in `/public/fonts/premium/`
2. Font URLs in `lib/fonts.ts` are correct
3. Browser console for 404 errors
4. Font is correctly saved in `site.config.theme.headingFontFamily`
5. `FontLoader` is rendered (check React DevTools)
6. Network tab shows font files loading (200 status)

**Fix:**
```bash
# Verify font files
ls -la public/fonts/premium/Jedira/
# Should show .woff2 files

# Check font URLs match file names
grep -r "Jedira" lib/fonts.ts
```

**Debug in browser:**
1. Open DevTools → Network tab
2. Filter by "woff2" or "font"
3. Reload page
4. Check if font files are requested and loaded (status 200)
5. Check if @font-face rules are injected (Elements tab → `<style id="premium-fonts-loader">`)

### Premium fonts disabled in selector despite having plan

**Check:**
1. Workspace plan has `feature_premium_fonts = true`
2. App context is loaded correctly
3. Browser cache (hard refresh: Cmd+Shift+R / Ctrl+Shift+R)

**Fix:**
```sql
-- Verify plan feature
SELECT w.name, w.plan, p.feature_premium_fonts 
FROM workspaces w
JOIN plans p ON p.name = w.plan
WHERE w.id = 'your-workspace-id';

-- Enable if needed
UPDATE plans SET feature_premium_fonts = true WHERE name = 'agency';
```

### Font shows as system font instead of custom

**Check:**
1. `FontLoader` is rendered in `PreviewSitePage` (check React DevTools)
2. Font files loaded (check Network tab - filter by "woff2")
3. Font family name matches exactly (case-sensitive)
4. @font-face rules are injected (check Elements tab → `<style id="premium-fonts-loader">`)
5. CSS `font-family` property uses exact font name

**Fix:**
```typescript
// Font name must match exactly (case-sensitive)
// In lib/fonts.ts:
value: 'Jedira',  // Must match font-family in @font-face

// In @font-face (generated by FontLoader):
font-family: 'Jedira';  // Must match value above

// In CSS (applied by theme):
fontFamily: 'Jedira'  // Must match value above
```

**Verify in browser:**
1. Open DevTools → Elements tab
2. Find `<style id="premium-fonts-loader">` in `<head>`
3. Check if @font-face rules are present
4. Inspect heading element → Computed styles → font-family should show "Jedira"

## Adding Custom Premium Fonts

See [PREMIUM_FONTS_IMPLEMENTATION.md](./PREMIUM_FONTS_IMPLEMENTATION.md#adding-new-premium-fonts) for detailed instructions.

Quick steps:
1. Add woff2 files to `/public/fonts/premium/YourFont/`
2. Add font definition to `premiumFonts` array in `lib/fonts.ts`
3. Done! Font appears automatically in selector

## Testing Checklist

- [ ] Database migration applied
- [ ] Plans updated with `feature_premium_fonts = true`
- [ ] Font files exist in `/public/fonts/premium/`
- [ ] Premium fonts appear in font selector (Settings tab)
- [ ] Premium fonts disabled for free/starter plans
- [ ] Premium fonts enabled for agency/enterprise plans
- [ ] Selected premium font saves to database
- [ ] Premium font loads correctly in builder preview (direct rendering)
- [ ] Premium font loads correctly in preview route (`/preview/[id]`)
- [ ] Premium font loads correctly on published site
- [ ] Font displays with correct weight
- [ ] Browser console has no errors
- [ ] Network tab shows font files loading (200 status)
- [ ] @font-face rules injected in `<style id="premium-fonts-loader">`
- [ ] Font family applied correctly in computed styles

## Support

If you encounter issues:
1. Check browser console for errors
2. Check Network tab for failed font requests
3. Verify database plan configuration
4. Review [PREMIUM_FONTS_IMPLEMENTATION.md](./PREMIUM_FONTS_IMPLEMENTATION.md)
